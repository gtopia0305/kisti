# 뉴론 lammps-16Mar18 (GPU 버전) 설치

KISTI 슈퍼컴퓨터센터의 장비에 lammps-16Mar18 source 버전으로 설치 하는 방법에 대하여 소개 한다.

\


**1. 설치 환경**

|   **구분**       | **내용**                            |
| -------------- | --------------------------------- |
|  대상 시스템        | 뉴론                                |
|  OS Version    | 리눅스 / CentOS 7.4                  |
|  CPU           | Intel Xeon E5-2670 v2             |
|  컴파일러          | Intel 2018 Version                |
|  MPI           | Mvapich2 2.3 Version              |
| <p> 기타<br></p> | Intel MKL Math Library, CUDA 10.0 |

\


\
**2. 설치 전 환경 설정**

KISTI 시스템은 PATH, LD\_LIBRARY\_PATH 등을 쉽게 하기 위하여 OpenSource 인 Environment Modules(http://modules.sourceforge.net)이 구성되어 있고, 이하 설치 소개 에서는 module load를 이용한 환경 설정 방법을 이용한다.&#x20;

**\[ 환경 설정 ]**

|  $ module load intel/18.0.2 cuda/10.0 cudampi/mvapich2-2.3 |
| ---------------------------------------------------------- |

\


\
**3. 설치 과정**

&#x20;설치 과정 소개는 tar 를 이용한 압축 해제 방법과 설정 방법등 진행 절차를 위주로 설명하고, 소스 파일 다운로드 등은 생략한다. \
&#x20;**(1) VORO++ 설치** (다운로드 : http://math.lbl.gov/voro++/download/)VORONOI 패키지 설치를 위한 voro++를 우선 설치한다.&#x20;

|   **설치과정**                                                                                                                                                                                     | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ tar xvf voro++-0.4.6.tar.gz</p><p>$ cd voro++-0.4.6</p><p>$ mkdir -p ${HOME}/build/library</p><p>$ vi config.mk</p><p> ----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make</p><p>$ make install</p> | <p><br></p> |

\


\[config.mk 수정 사항]

| <p>CXX=mpicxx</p><p>CFLAGS= -Wall -ansi -pedantic -O3 -fPIC</p><p>E_INC= -I../../src</p><p>E_LIB= -L../../src</p><p>PREFIX= ${HOME}/build/library</p><p>INSTALL= install</p><p>IFLAGS_EXEC= -m 0755</p><p>IFLAGS= -m 0644</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\
\


&#x20;**(2) LATTE 설치** (다운로드 : https://github.com/lanl/LATTE/releases)

LATTTE 패키지 설치를 위한 Latte 라이브러리를 우선 설치한다.

다운로드 받은 파일을 적당한 위치($HOME/build)에 올린 후 다음과 같은 명령으로 압축 묶음 파일을 푼다.

|   **설치과정**                                                                                                                                                       | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd ${HOME}/build</p><p>$ tar xvf LATTE-1.2.1.tar.gz</p><p>$ cd LATTE-1.2.1</p><p>$ vi makefile.CHOICES</p><p> ----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make</p> | <p><br></p> |

\
\[makefile.CHOICES 수정 사항]

| <p>#</p><p># CPU Fortran options</p><p>#</p><p> </p><p>#For GNU compiler:</p><p>#FC = mpif90</p><p>#FC = gfortran</p><p>#FCL = $(FC)</p><p>#FFLAGS = -O3 -fopenmp -cpp</p><p>#FFLAGS = -fast -Mpreprocess -mp</p><p>#LINKFLAG = -fopenmp</p><p> </p><p>#For intel compiler:</p><p>FC = ifort</p><p>FCL = $(FC)</p><p>FFLAGS = -O3 -fpp -qopenmp</p><p>LINKFLAG = -qopenmp</p><p>#LIB = -mkl=parallel</p><p><br></p><p>#GNU BLAS/LAPACK libraries:</p><p>LIB = -llapack -lblas</p><p> </p><p>#Intel MKL BLAS/LAPACK libraries:</p><p>LIB = -Wl,--no-as-needed -L${MKLROOT}/lib/intel64 \</p><p>-lmkl_lapack95_lp64 -lmkl_gf_lp64 -lmkl_gnu_thread -lmkl_core \</p><p>-lmkl_gnu_thread -lmkl_core -ldl -lpthread -lm</p><p> </p><p>#Alternative flags for MKL:</p><p>LIB += -mkl=parallel</p><p><br></p><p>#</p><p># GPU options</p><p>#</p><p> </p><p>GPU_CUDA_LIB = -L/apps/cuda/10.0/lib64 -lcublas -lcudart</p><p>GPU_ARCH = sm_35</p><p>GPU_ARCH = sm_70</p><p><br></p> | <p><br></p> |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |

\


\


&#x20;**(3) 라이브러리 패키지 설치**

LAMMPS 홈페이지(http://lammps.sandia.gov/index.html)로부터 다운로드 받은 파일을 적당한 위치($HOME/build)에 올린 후 다음과 같은 명령으로 압축 묶음 파일을 푼다.

| $ tar xvf lammps-16Mar18.tar.gz | <p><br></p> |
| ------------------------------- | ----------- |

\


\


&#x20;(3-1) voronoi 설치

(1)에서 설치한 voro++ 설치 디렉토리를 지정해 준다.

lammps 압축 해제후 lammps-16Mar18 폴더로 이동하여 아래의 작업을 진행한다.

|   **설치과정**                                                                                                                                                                         | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd lammps-16Mar18</p><p>$ cd lib/voronoi</p><p>$ ln -s ${HOME}/build/library/include/voro++ includelink</p><p>$ ln -s ${HOME}/build/library/lib liblink</p><p>$ cd ../../</p> | <p><br></p> |

\


&#x20;(3-2) poems 설치

|   **설치과정**                                                           | <p><br></p> |
| -------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/poems</p><p>$ make -f Makefile.icc</p><p>$ cd ../../</p> | <p><br></p> |

\


&#x20;(3-3) meam 설치

|   **설치과정**                                                                                                                                | <p><br></p> |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/meam</p><p>$ vi Makefile.lammps.ifort</p><p>----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make -f Makefile.ifort</p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.lammps.ifort 수정 사항]

\


\


| <p>meam_SYSINC=</p><p>meam_SYSLIB=</p><p>meam_SYSPATH=</p> |
| ---------------------------------------------------------- |

##

&#x20;(3-4) awpmd 설치

|   **설치과정**                                                                                                                                     | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/awpmd</p><p>$ vi Makefile.lammps.installed</p><p>----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make -f Makefile.mpicc</p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.lammps.installed 수정 사항]

\


| <p>user-awpmd_SYSINC =</p><p>user-awpmd_SYSLIB =</p><p>user-awpmd_SYSPATH =</p> |
| ------------------------------------------------------------------------------- |

\
\
\


&#x20;(3-5) atc 설치

|   **설치과정**                                                                                                                                                                                                         | <p><br></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------- |
| <p>$ cd lib/atc</p><p>$ vi Makefile.lammps.installed</p><p>----- 수정 사항은 아래의 내용 참고 -----</p><p>$ vi Makefile.lammps.linalg</p><p>----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make -f Makefile.mpic++</p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.lammps.installed 수정 사항]

\


\


| <p>user-atc_SYSINC =</p><p>user-atc_SYSLIB =</p><p>user-atc_SYSPATH =</p> |
| ------------------------------------------------------------------------- |

\


\


\


\


\


\[Makefile.lammps.linalg 수정 사항]

\


| <p>user-atc_SYSINC =</p><p>user-atc_SYSLIB = -llinalg</p><p>user-atc_SYSPATH = -L../../lib/linalg$(LIBOBJDIR)</p> |
| ----------------------------------------------------------------------------------------------------------------- |

\


\


&#x20;(3-6) linalg 설치

|   **설치과정**                                                                                                                                                                          | <p><br></p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/linalg</p><p>$ cp -p Makefile.gfortran Makefile.ifort</p><p>$ vi Makefile.ifort</p><p>----- 수정 사항은 아래의 내용 참고 -----</p><p>$ make -f Makefile.ifort</p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.ifort 수정 사항]

\


\


| <p>FC = ifort</p><p>FFLAGS = -O3 -fPIC</p><p>FFLAGS0 = -O0 -fPIC</p> |
| -------------------------------------------------------------------- |

\


\


&#x20;(3-7) reax 설치

|   **설치과정**                                                            | <p><br></p> |
| --------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/reax</p><p>$ make -f Makefile.ifort</p><p>$ cd ../../</p> | <p><br></p> |

\


&#x20;(3-8) latte 설치

|   **설치과정**                                                                                                                                                                                                                                                                               | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p>$ cd lib/latte</p><p>$ ln -s ${HOME}/build/LATTE-1.2.1/src includelink</p><p>$ ln -s ${HOME}/build/LATTE-1.2.1 liblink</p><p>$ ln -s ${HOME}/build/LATTE-1.2.1/src/latte_c_bind.o filelink.o</p><p>$ vi Makefile.lammps.mpi</p><p>----- 수정 사항은 아래의 내용 참고 ----- </p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.lammps.mpi 수정 사항]

\


\


| <p>latte_SYSINC =</p><p>latte_SYSLIB = ../../lib/latte/filelink.o -llatte -llinalg -lifport</p><p>latte_SYSPATH = -L../../lib/linalg -qopenmp</p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------- |

\
\
&#x20;(3-9) gpu 설치

|   **설치과정**                                                                                                                                                                                                               | <p><br></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------- |
| <p>$ cd lib/gpu</p><p>$ vi Makefile.linux</p><p>----- 수정 사항은 아래의 내용 참고 ----- </p><p>$ vi Makefile.mpi</p><p>----- 수정 사항은 아래의 내용 참고 ----- </p><p>$ make -f Makefile.linux</p><p>$ ./nvc_get_devices</p><p>$ cd ../../</p> | <p><br></p> |

\


\


\[Makefile.linux 수정 사항]

\


\


| <p><br></p><p>CUDA_HOME = /apps/cuda/10.0</p><p><br></p><p># Tesla CUDA</p><p>CUDA_ARCH = -arch=sm_70</p><p><br>#CUDA_ARCH = -arch=sm_10 -DCUDA_PRE_THREE#CUDA_ARCH = -arch=sm_35<br></p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


\


\
\


\[Makefile.mpi 수정 사항]

\


\


\


| <p><br></p><p>CUDA_HOME = /apps/cuda/10.0</p><p><br></p><p># Tesla CUDA</p><p>CUDA_ARCH = -arch=sm_70</p><p><br>#CUDA_ARCH = -arch=sm_10 -DCUDA_PRE_THREE#CUDA_ARCH = -arch=sm_35<br>include /home01/optpar05/build/lammps-16Mar18/lib/gpu/Makefile.mpi<br></p> |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

\


\


&#x20;(4) LAMMPS 설치

lammps 설치 디렉토리(${HOME}/build/lammps-16Mar18) 아래 src 폴더로 이동한다.

\


&#x20;\- package 선택 및 설치

사용하는 사용자의 연구내용에 맞추어 필요한 package를 선택하여 설치한다. 여기서는 기본적으로 많이 사용되는 package를 위주로 설치하였다.

|   **설치과정**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                              |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p>$ cd src</p><p>$ make package-status</p><p>$ make yes-standard</p><p>$ make no-kim</p><p>$ make no-KOKKOS</p><p>$ make no-MSCG</p><p>$ make no-PYTHON</p><p>$ make yes-GPU</p><p>$ make yes-USER-ATC</p><p>$ make yes-USER-AWPMD</p><p>$ make yes-USER-MEAMC</p><p>$ make yes-USER-MISC</p><p>$ make yes-USER-OMP</p><p>$ make yes-USER-REAXC</p><p>$ make package-status</p><p><br></p><p>$ vi MAKE/Makefile.mpi</p><p>-- 수정 사항은 아래 내용 참고 --</p><p>$ vi Makefile.package.settings</p><p>-- 수정 사항은 아래 내용 참고 --</p><p>$ make mpi</p> | <p> </p><p> package 선택 확인</p><p> standard package 선택</p><p> standard package 중 kim package 제외</p><p> standard package 중 KOKKOS package 제외</p><p> standard package 중 MSCG package 제외</p><p> standard package 중 PYTHON package 제외</p><p><br></p><p><br></p><p><br></p><p><br></p><p><br></p><p><br></p><p> package 선택 확인</p><p><br></p><p><br></p><p><br></p><p><br></p><p><br></p><p><br></p> |

\


\[MAKE/Makefile.mpi 수정 사항]

| <p><br></p><p>CC =        mpicxx</p><p>OPTFLAGS = -O3 -fp-model fast=2 -no-prec-div -qoverride-limits</p><p>CCFLAGS =   -qopenmp -qno-offload -fno-alias -ansi-alias -restrict \</p><p>-DLMP_INTEL_USELRT -DLMP_USE_MKL_RNG $(OPTFLAGS)</p><p>CCFLAGS += -I/apps/compiler/intel/18.0.2/mkl/include/ -lmkl_rt -I/${HOME}/build/library/include/voro++ \</p><p>-I/apps/cuda/10.0/include</p><p>SHFLAGS =   -fPIC</p><p>DEPFLAGS =  -M</p><p><br></p><p>LINK =      mpicxx</p><p>LINKFLAGS = -qopenmp $(OPTFLAGS)</p><p>LIB = -L/apps/cuda/10.0/lib64 -lcudart -lcuda -L/apps/compiler/intel/18.0.2/lib/intel64 -lifport</p><p>SIZE =      size</p><p><br></p><p>ARCHIVE =   ar</p><p>ARFLAGS =   -rc</p><p>SHLIBFLAGS =    -shared</p><p><br></p><p><br></p><p>FFT_INC =       -DFFT_MKL -DFFT_SINGLE</p><p>FFT_PATH =</p><p>FFT_LIB =   -L${MKLROOT}/lib/intel64/ -lmkl_intel_ilp64 -lmkl_sequential -lmkl_core</p><p><br></p> |   |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | - |

\


\


\[Makefile.package.settings 수정 사항]

\


\


| <p><br></p><p>include ../../lib/awpmd/Makefile.lammps</p><p>include ../../lib/atc/Makefile.lammps</p><p>include ../../lib/gpu/Makefile.mpi</p><p>include ../../lib/voronoi/Makefile.lammps</p><p>include ../../lib/reax/Makefile.lammps</p><p>include ../../lib/poems/Makefile.lammps</p><p>include ../../lib/meam/Makefile.lammps</p><p>include ../../lib/latte/Makefile.lammps.mpi</p><p>include ../../lib/compress/Makefile.lammps</p><p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

##

**4. 실행 파일 복사**

&#x20;설치가 완료되면 사용에 편의를 위해 bin 경로를 만들어 실행 파일인 lmp\_mpi를 bin 경로에 복사한다.(선택사항)

\


| <p><br></p><p>$ ls -l lmp_mpi</p><p>$ cd ${HOME}/build/lammps-16Mar18/</p><p>$ mkdir bin</p><p>$ cp ${HOME}/build/lammps-16Mar18/src/lmp_mpi .</p><p><br></p> |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------- |

##

**5. 뉴론에서 LAMMPS 사용을 위한 SLURM 작업 스크립트 예제**

&#x20;위의 과정을 거처 설치된 lammps는 뉴론 환경에서 다음과 같이 실행이 가능하다.

뉴론에서 작업을 제출하기 위해서는 SLURM 작업 스크립트를 사용하여야 한다.

&#x20;

실행 예제로는 examples/meam 아래의 데이터를 이용하였다.

|   **작업스크립트 예제(lammps\_test-run.sh)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | <p><br></p> |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| <p><br></p><p>#!/bin/sh<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -J test<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -p ivy_v100_2<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -N 1<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -n 10<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -o %x_%j.out<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -e %x_%j.err<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> -t 00:30:00<br><a href="tg://search_hashtag?hashtag=SBATCH">#SBATCH</a> --gres=gpu:2</p><p>#SBATCH --comment lammps<br><br>module load intel/18.0.2 cuda/10.0 cudampi/mvapich2-2.3<br><br>ulimit -s unlimited<br><br>export PATH=${HOME}/build/lammps-16Mar18:$PATH<br><br>srun lmp_mpi -sf gpu -pk gpu 2 -in peri/in.peri</p><p><br></p> | <p><br></p> |

\
